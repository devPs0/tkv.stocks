{% extends "base.html" %}

{% block title %}Settings - Tkv.stocks{% endblock %}

{% block content %}
<div class="page-header">
    <div class="container">
        <h1 class="page-title">
            <i class="fas fa-cog"></i>
            Settings & Configuration
        </h1>
        <p class="page-subtitle">Configure your Tkv.stocks application</p>
    </div>
</div>

<div class="grid grid-2" style="margin-bottom: 2rem;">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-clock"></i>
                Scheduled Fetching
            </h3>
        </div>
        <form id="schedule-form">
            <div class="form-group">
                <label class="form-label">Auto-fetch Symbols</label>
                <textarea class="form-input" rows="3" placeholder="TCS.NS,RELIANCE.NS,INFY.NS" 
                          style="resize: vertical;">TCS.NS,RELIANCE.NS</textarea>
                <small>Comma-separated list of symbols to fetch daily</small>
            </div>
            <div class="form-group">
                <label class="form-label">Fetch Time</label>
                <input type="time" class="form-input" value="01:00">
                <small>Time for daily automatic fetching (24-hour format)</small>
            </div>
            <div class="form-group">
                <label class="form-label">
                    <input type="checkbox" checked> Enable scheduled fetching
                </label>
            </div>
            <button type="submit" class="btn btn-primary">
                <i class="fas fa-save"></i>
                Save Schedule Settings
            </button>
        </form>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-server"></i>
                System Configuration
            </h3>
        </div>
        <div class="config-item">
            <label>Database URL</label>
            <input type="text" class="form-input" value="postgresql://postgres:***@db:5432/stockdb" disabled>
        </div>
        <div class="config-item">
            <label>Redis URL</label>
            <input type="text" class="form-input" value="redis://redis:6379/0" disabled>
        </div>
        <div class="config-item">
            <label>Environment</label>
            <select class="form-input">
                <option value="development" selected>Development</option>
                <option value="production">Production</option>
            </select>
        </div>
        <div class="config-item">
            <label>API Rate Limiting</label>
            <div class="grid grid-2">
                <input type="number" class="form-input" value="100" placeholder="Requests">
                <select class="form-input">
                    <option value="minute">per minute</option>
                    <option value="hour" selected>per hour</option>
                    <option value="day">per day</option>
                </select>
            </div>
        </div>
    </div>
</div>

<div class="grid grid-2" style="margin-bottom: 2rem;">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-bell"></i>
                Notifications
            </h3>
        </div>
        <div class="notification-settings">
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" checked>
                    <span>Email notifications for fetch completion</span>
                </label>
            </div>
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox">
                    <span>SMS alerts for significant price changes</span>
                </label>
            </div>
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" checked>
                    <span>Error notifications</span>
                </label>
            </div>
            <div class="form-group">
                <label class="form-label">Email Address</label>
                <input type="email" class="form-input" placeholder="your.email@example.com">
            </div>
            <div class="form-group">
                <label class="form-label">Phone Number</label>
                <input type="tel" class="form-input" placeholder="+91 9876543210">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3 class="card-title">
                <i class="fas fa-brain"></i>
                ML Model Settings
            </h3>
        </div>
        <div class="form-group">
            <label class="form-label">Prediction Model</label>
            <select class="form-input">
                <option value="lstm">LSTM Neural Network</option>
                <option value="random_forest" selected>Random Forest</option>
                <option value="svm">Support Vector Machine</option>
                <option value="linear_regression">Linear Regression</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Training Data Period</label>
            <select class="form-input">
                <option value="6M">6 Months</option>
                <option value="1Y" selected>1 Year</option>
                <option value="2Y">2 Years</option>
                <option value="5Y">5 Years</option>
            </select>
        </div>
        <div class="form-group">
            <label class="form-label">Retrain Frequency</label>
            <select class="form-input">
                <option value="daily">Daily</option>
                <option value="weekly" selected>Weekly</option>
                <option value="monthly">Monthly</option>
                <option value="manual">Manual Only</option>
            </select>
        </div>
        <button class="btn btn-secondary">
            <i class="fas fa-sync"></i>
            Retrain Models Now
        </button>
    </div>
</div>

<div class="card" style="margin-bottom: 2rem;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-shield-alt"></i>
            Security & Access
        </h3>
    </div>
    <div class="grid grid-2">
        <div>
            <h5>API Access</h5>
            <div class="form-group">
                <label class="form-label">API Key</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="password" class="form-input" value="sk_test_1234567890abcdef" disabled>
                    <button class="btn btn-secondary">
                        <i class="fas fa-eye"></i>
                    </button>
                    <button class="btn btn-secondary">
                        <i class="fas fa-sync"></i>
                    </button>
                </div>
            </div>
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" checked>
                    <span>Require API key for all endpoints</span>
                </label>
            </div>
        </div>
        <div>
            <h5>Data Security</h5>
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" checked>
                    <span>Encrypt sensitive data at rest</span>
                </label>
            </div>
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox" checked>
                    <span>Enable audit logging</span>
                </label>
            </div>
            <div class="setting-item">
                <label class="setting-label">
                    <input type="checkbox">
                    <span>Anonymous usage analytics</span>
                </label>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-tools"></i>
            System Tools
        </h3>
    </div>
    <div class="grid grid-4">
        <button class="btn btn-secondary" onclick="testConnection()">
            <i class="fas fa-network-wired"></i>
            Test Connections
        </button>
        <button class="btn btn-secondary" onclick="clearCache()">
            <i class="fas fa-broom"></i>
            Clear Cache
        </button>
        <button class="btn btn-secondary" onclick="exportSettings()">
            <i class="fas fa-download"></i>
            Export Settings
        </button>
        <button class="btn btn-danger" onclick="resetSettings()">
            <i class="fas fa-undo"></i>
            Reset to Defaults
        </button>
    </div>
    
    <div style="margin-top: 2rem;">
        <h5>System Status</h5>
        <div class="grid grid-4" id="system-status">
            <div class="status-item">
                <i class="fas fa-database"></i>
                <span>Database</span>
                <span class="badge badge-success">Connected</span>
            </div>
            <div class="status-item">
                <i class="fas fa-memory"></i>
                <span>Redis</span>
                <span class="badge badge-success">Connected</span>
            </div>
            <div class="status-item">
                <i class="fas fa-cogs"></i>
                <span>Worker</span>
                <span class="badge badge-success">Running</span>
            </div>
            <div class="status-item">
                <i class="fas fa-chart-line"></i>
                <span>API</span>
                <span class="badge badge-success">Healthy</span>
            </div>
        </div>
    </div>
</div>

<style>
.config-item {
    margin-bottom: 1rem;
}

.config-item label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-primary);
}

.notification-settings .setting-item {
    margin-bottom: 1rem;
}

.setting-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    color: var(--text-primary);
}

.setting-label input[type="checkbox"] {
    margin: 0;
}

.status-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem;
    background: var(--light);
    border-radius: 8px;
    border: 1px solid var(--border);
}

.status-item i {
    color: var(--primary);
}

.status-item span:first-of-type {
    flex: 1;
    font-weight: 500;
    color: var(--text-primary);
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('schedule-form').addEventListener('submit', (e) => {
    e.preventDefault();
    window.stockPredictor.showSuccess('Schedule settings saved successfully');
});

function testConnection() {
    window.stockPredictor.showLoading('Testing system connections...');
    
    setTimeout(() => {
        window.stockPredictor.showSuccess('All connections are healthy');
    }, 2000);
}

function clearCache() {
    if (confirm('Are you sure you want to clear all cached data?')) {
        window.stockPredictor.showLoading('Clearing cache...');
        
        setTimeout(() => {
            window.stockPredictor.showSuccess('Cache cleared successfully');
        }, 1000);
    }
}

function exportSettings() {
    const settings = {
        schedule: {
            symbols: 'TCS.NS,RELIANCE.NS',
            time: '01:00',
            enabled: true
        },
        notifications: {
            email: true,
            sms: false,
            errors: true
        },
        model: {
            type: 'random_forest',
            training_period: '1Y',
            retrain_frequency: 'weekly'
        }
    };
    
    const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `tkv_stocks_settings_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    window.stockPredictor.showSuccess('Settings exported successfully');
}

function resetSettings() {
    if (confirm('Are you sure you want to reset all settings to defaults? This action cannot be undone.')) {
        window.stockPredictor.showLoading('Resetting settings...');
        
        setTimeout(() => {
            window.stockPredictor.showSuccess('Settings reset to defaults');
            location.reload();
        }, 2000);
    }
}

// Update system status periodically
function updateSystemStatus() {
    // This would typically make API calls to check system health
    const statusItems = document.querySelectorAll('.status-item .badge');
    statusItems.forEach(badge => {
        // Simulate occasional status changes
        if (Math.random() > 0.95) {
            badge.className = 'badge badge-warning';
            badge.textContent = 'Warning';
        } else {
            badge.className = 'badge badge-success';
            badge.textContent = badge.parentElement.children[1].textContent === 'Database' ? 'Connected' :
                             badge.parentElement.children[1].textContent === 'Redis' ? 'Connected' :
                             badge.parentElement.children[1].textContent === 'Worker' ? 'Running' : 'Healthy';
        }
    });
}

setInterval(updateSystemStatus, 30000); // Update every 30 seconds
</script>
{% endblock %}